# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–≥–æ –ø–æ—Å–ª–µ merge conflicts

## –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ merge conflict 3db80ad –±—ã–ª–æ –ø–æ—Ç–µ—Ä—è–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π. –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —á—Ç–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. API Endpoints –¥–ª—è Frontend (47 ‚Üí 51 endpoint)

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–µ—Å—Å–∏–∏:**
- `GET /api/users` - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `GET /api/settings/app-categories` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
- `GET /api/activity/segments` - —Å–µ–≥–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è timeline
- `GET /api/screenshot/:id` - alias –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤

**–§–∞–π–ª—ã:** `server/main.go`, `server/handlers.go`, `server/database/clickhouse.go`

---

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ –≤ —Ñ–∞–π–ª ‚úÖ –¢–û–õ–¨–ö–û –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ merge conflict –ø—Ä–æ–ø–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–∞–π–ª
- –ê–≥–µ–Ω—Ç –ø–∏—Å–∞–ª –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª—å
- –§–∞–π–ª `C:\ProgramData\MonitoringAgent\agent.log` –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è

**–ß—Ç–æ –±—ã–ª–æ –ø–æ—Ç–µ—Ä—è–Ω–æ:**
```go
// ‚ùå –ù–ï –ë–´–õ–û –∏–º–ø–æ—Ä—Ç–∞ logger
// ‚ùå –ù–ï –ë–´–õ–û –≤—ã–∑–æ–≤–∞ logger.Init()
```

**–ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:**
```go
// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç
import "github.com/ctolnik/Office-Monitor/agent/logger"

// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main()
if cfg.Logging.File != "" {
    if err := logger.Init(cfg.Logging.File); err != nil {
        log.Printf("WARNING: Failed to initialize file logging: %v", err)
    } else {
        log.Printf("Logging to file: %s", cfg.Logging.File)
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ `C:\ProgramData\MonitoringAgent\agent.log`
- ‚úÖ Graceful fallback - –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å console
- ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–§–∞–π–ª—ã:** `agent/main.go`

---

### 3. –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö /api/events/batch ‚úÖ –¢–û–õ–¨–ö–û –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ê–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{"events": [...]}`
- –°–µ—Ä–≤–µ—Ä –æ–∂–∏–¥–∞–ª –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤ `[...]`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: 400 Bad Request "Invalid request"

**–†–µ—à–µ–Ω–∏–µ:**
–ü–µ—Ä–µ–ø–∏—Å–∞–Ω handler `receiveBatchEventsHandler`:

```go
// –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
type GenericEvent struct {
    Type      string          `json:"type"`
    Timestamp time.Time       `json:"timestamp"`
    Data      json.RawMessage `json:"data"`
}

type BatchEventsRequest struct {
    Events []GenericEvent `json:"events"`
}

// Handler —Ç–µ–ø–µ—Ä—å:
// 1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç {"events": [...]}
// 2. –ü–∞—Ä—Å–∏—Ç –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å type/timestamp/data
// 3. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–ª—è "data"
// 4. –§–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ type="activity"
// 5. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ ClickHouse
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –û—à–∏–±–∫–∞ 400 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- ‚úÖ –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏

**–§–∞–π–ª—ã:** `server/main.go` (lines 202-302)

---

## ‚ùå –û–°–¢–ê–õ–û–°–¨ –ò–°–ü–†–ê–í–ò–¢–¨

### –û—à–∏–±–∫–∞ 500: Activity Segments

**–°–∏–º–ø—Ç–æ–º—ã:**
```
Server returned non-OK status for activity segment: 500
```

**–í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –¢–∞–±–ª–∏—Ü–∞ `monitoring.activity_segments` –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –≤ production ClickHouse
- –ò–ª–∏ —Å—Ö–µ–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å INSERT –∑–∞–ø—Ä–æ—Å–æ–º

**–†–µ—à–µ–Ω–∏–µ:**
–°–º. —Ñ–∞–π–ª `AGENT_ERROR_FIX.md` - —Ç–∞–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏ —Å–æ–∑–¥–∞–Ω–∏—é —Ç–∞–±–ª–∏—Ü—ã.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –°—Ç–∞—Ç—É—Å |
|-----------|------|-------|--------|
| API endpoints | 47 | 51 | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Agent logging | ‚ùå –¢–æ–ª—å–∫–æ –∫–æ–Ω—Å–æ–ª—å | ‚úÖ –§–∞–π–ª + –∫–æ–Ω—Å–æ–ª—å | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Events batch format | ‚ùå 400 error | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| Activity segments | ‚ùå 500 error | ‚ùì –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞ | ‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–û–±–Ω–æ–≤–∏—Ç—å production —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   cd /path/to/Office-Monitor
   git pull origin main
   docker-compose build server
   docker-compose up -d
   ```

2. **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∞–≥–µ–Ω—Ç** (Windows):
   - –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–π `agent.exe` –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∞–≥–µ–Ω—Ç
   - –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π –∞–≥–µ–Ω—Ç
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è `C:\ProgramData\MonitoringAgent\agent.log`

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É 500:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã ClickHouse
   - –°–æ–∑–¥–∞—Ç—å `activity_segments` –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 24 –Ω–æ—è–±—Ä—è 2025  
**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:** `server/main.go`, `agent/main.go`  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 3 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –±–∞–≥–∞
